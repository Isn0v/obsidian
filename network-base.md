## Модели сетей
![[network-models_1.jpg]]

## Что происходит когда...
***



### Парсится URL
-  Проверяется HSTS (HTTP Strict Transport Security).
	Это список, который содержит URL, пропускаемые только через HTTPS. Помогает от атак типа "человек по-середине"
-  Поиск DNS
	Домен в кэше? Нет, значит зовем `gethostbyname`, который дергает `hosts` файл. Нету и там? Обращаемся с запросом на имя к сконфигурированному на компе адресу сервера DNS (роутер или ISP (Internet Srevice Provider) DNS). DNS в локальной подсети? Вызываем ARP для DNS сервера. DNS в другой подсети? Вызываем ARP от шлюза дефолтного IP (пропускаем через шлюз в другое место).
-  ARP (Adress resolution protocol) рассылка
	Протокол, позволяющий по известному IP найти MAC адрес устройства и затем взаимодействовать с ним (нужно, например, когда надо обмениваться данными по ethernet)
	1. Смотрим кэш  ARP. Нужного получателя нет? Делаем рассылку запросов в стиле: "Кто-нибудь знает физический адрес устройства, обладающего таким-то адресом IP". Кто-то ответит на эту рассылку и отправит свой MAC адрес
- Открытие сокета
	- Знаем IP и MAC адрес цели и возвращаемся к нахождению адреса DNS. Ответ небольшой? Открываем UDP с >1023 на 53 порт. Ответ большой? Используем TCP. DNS сервер не знает имени? Рекурсивно отправляется  запрос на более 'крутой' DNS из списка серверов до SOA (Start of Authority).
	- Получили IP адрес относительно домена. Инициируем запрос (через TCP сокет или поток) на этот IP по известному порту (HTTP -> 80, HTTPS -> 443). 
		1. Формируем TCP сегмент на транспортном уровне. Порт назначения в заголовок, а порт отправителя выбирается из массива динамически размеченных портов `ip_local_port_range`
		2. На сетевом уровне в заголовок добавляется информация о IP адресе назначения и отправителя
		3. На связующем (link) слое. Добавляется заголовок фрейма, в котором инфа о MAC самой машины и шлюза (роутера, опять же, этот MAC адрес можно получить через ARP)
		4. Рано или поздно мы достигаем какой-то локальной подсети. В ней пакет также путешествует по роутерам, каждый из которых перенаправляет пакет к другому роутеру (это есть `hop`). В этот момент декрементируется значение TTL (Time To Live). Если TTL = 0 или очередь роутера заполнена, пакет умирает.
-  Как работает TCP (установка и разрыв соединения)
	![[tcp-handshake-diagram.png]]
- TLS рукопожатие
	Ты это вроде прочитал и очень хорошо понял. Кратко: у сервера есть сертификат, заверенный CA. Сервер передает публичный ключ клиенту. Клиент шифрует данные (для формирования симметричного ключа в дальнейшем) публичным ключом и отправляет. Сервер получает и дешифрует приватным ключом и генерирует свой симметричный ключ. Клиент генерирует хэш и шифрует симметричным ключом. Сервер генерирует свой хэш и дешифрует полученный хэш от клиента. Если хэши совпадают, соединение успешно.
- Перегрузка TCP
